(()=>{"use strict";var e={186:(e,t,a)=>{e.exports=a.p+"2429af6d3a5796e3c34b.png"},227:(e,t,a)=>{e.exports=a.p+"f5c75398bcb5931f9f3c.png"},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},756:(e,t,a)=>{e.exports=a.p+"bf0ed0dca1d1e6091d42.png"},1016:(e,t,a)=>{a.d(t,{A:()=>He});var r=a(1601),n=a.n(r),i=a(6314),s=a.n(i),o=a(4417),l=a.n(o),c=new URL(a(7935),a.b),h=new URL(a(1409),a.b),d=new URL(a(3232),a.b),p=new URL(a(1265),a.b),u=new URL(a(6267),a.b),m=new URL(a(186),a.b),f=new URL(a(9745),a.b),g=new URL(a(8490),a.b),b=new URL(a(2573),a.b),v=new URL(a(4496),a.b),y=new URL(a(8956),a.b),C=new URL(a(9221),a.b),w=new URL(a(6092),a.b),P=new URL(a(4184),a.b),x=new URL(a(5513),a.b),L=new URL(a(3062),a.b),k=new URL(a(4875),a.b),R=new URL(a(5134),a.b),M=new URL(a(7335),a.b),S=new URL(a(6153),a.b),U=new URL(a(9e3),a.b),E=new URL(a(9593),a.b),T=new URL(a(5523),a.b),$=new URL(a(7986),a.b),z=new URL(a(4041),a.b),G=new URL(a(7538),a.b),B=new URL(a(1605),a.b),A=new URL(a(6318),a.b),O=new URL(a(3933),a.b),I=new URL(a(6291),a.b),N=new URL(a(9702),a.b),D=new URL(a(1906),a.b),F=new URL(a(4347),a.b),j=new URL(a(1216),a.b),q=new URL(a(4437),a.b),H=new URL(a(3160),a.b),_=new URL(a(8341),a.b),J=new URL(a(2076),a.b),W=new URL(a(3860),a.b),Q=new URL(a(6943),a.b),Y=new URL(a(6168),a.b),K=new URL(a(227),a.b),V=new URL(a(756),a.b),X=new URL(a(9334),a.b),Z=s()(n()),ee=l()(c),te=l()(h),ae=l()(d),re=l()(p),ne=l()(u),ie=l()(m),se=l()(f),oe=l()(g),le=l()(b),ce=l()(v),he=l()(y),de=l()(C),pe=l()(w),ue=l()(P),me=l()(x),fe=l()(L),ge=l()(k),be=l()(R),ve=l()(M),ye=l()(S),Ce=l()(U),we=l()(E),Pe=l()(T),xe=l()($),Le=l()(z),ke=l()(G),Re=l()(B),Me=l()(A),Se=l()(O),Ue=l()(I),Ee=l()(N),Te=l()(D),$e=l()(F),ze=l()(j),Ge=l()(q),Be=l()(H),Ae=l()(_),Oe=l()(J),Ie=l()(W),Ne=l()(Q),De=l()(Y),Fe=l()(K),je=l()(V),qe=l()(X);Z.push([e.id,`:root {\n  --cell-size: 64px;\n}\n\nhtml, body {\n  height: 100%;\n  margin: 0;\n}\n\nbody {\n  background: #000;\n  font-size: 16px;\n}\n\n.btn {\n  display: inline-block;\n  font-weight: 400;\n  color: #212529;\n  background-color: #f8f9fa;\n  text-align: center;\n  vertical-align: middle;\n  padding: .375rem .75rem;\n  font-size: 1rem;\n  line-height: 1.5;\n  border-radius: .25rem;\n  transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;\n  border: none;\n  cursor: pointer;\n}\n\n.controls {\n  text-align: center;\n  margin: 50px 0 10px 0;\n}\n\n.display {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  text-align: center;\n  margin: 10px 0 20px 0;\n}\n\n.info-panel {\n  display: flex;\n  flex-direction: column;\n  width: 20rem;\n  padding: 0 20px;\n  color: #fff;\n  font-size: 2rem;\n  background-color: #347134;\n  border: 2px solid #fff;\n  border-radius: 1rem;  \n}\n\n.level {\n  display: flex;\n  justify-content: space-between;\n}\n\n.points {\n  display: flex;\n  justify-content: space-between;\n}\n\n.message-panel {\n  height: 2rem;\n  text-align: center;\n  margin-top: 10px;\n}\n\n.message-error {\n  color: #ff5a5a;\n  font-size: 2rem;\n}\n\n.message-good {\n  color: #6dd06d;\n  font-size: 3rem;\n}\n\n.message-bad {\n  color: #dc9e0e;\n  font-size: 3rem;\n}\n\n.message-info {\n  color: #0e9bdc;\n  font-size: 3rem;\n}\n\n.board-container {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  flex-wrap: wrap;\n}\n\n.board {\n  display: grid;\n  grid-template-columns: repeat(8, 1fr);\n  grid-column-gap: 2px;\n  grid-row-gap: 2px;\n}\n\n.cell {\n  position: relative;  \n}\n\n.cell.selected::before {\n  content: '';\n  display: block;\n  border: 4px;\n  border-radius: 32px;\n  box-sizing: border-box;\n  width: var(--cell-size);\n  height: var(--cell-size);\n  opacity: 0.9;\n  position: absolute;\n  z-index: 99;\n}\n\n.cell.selected-yellow::before {\n  border-color: #ff0;\n  border-style: solid;\n}\n\n.cell.selected-green::before {\n  border-color: #0f0;\n  border-style: dashed;\n}\n\n.cell.selected-red::before {\n  border-color: #f00;\n  border-style: dashed;\n}\n\n.cell.highlight::after { \n  content: '';\n  display: block;\n  box-sizing: border-box;\n  width: var(--cell-size);\n  height: var(--cell-size);\n  opacity: 0.5;\n}\n\n.cell.highlight-green::after { \n  background-color: #0d540d;\n}\n\n.cell.highlight-red::after { \n  background-color: #f00;\n}\n\n.board.prairie {\n  --map-tile-top-left-url: url(${ee});\n  --map-tile-top-url: url(${te});\n  --map-tile-top-right-url: url(${ae});\n  --map-tile-bottom-left-url: url(${re});\n  --map-tile-bottom-url: url(${ne});\n  --map-tile-bottom-right-url: url(${ie});\n  --map-tile-left-url: url(${se});\n  --map-tile-right-url: url(${oe});\n  --map-tile-center-url: url(${le});\n}\n\n.board.desert {\n  --map-tile-top-left-url: url(${ce});\n  --map-tile-top-url: url(${he});\n  --map-tile-top-right-url: url(${de});\n  --map-tile-bottom-left-url: url(${pe});\n  --map-tile-bottom-url: url(${ue});\n  --map-tile-bottom-right-url: url(${me});\n  --map-tile-left-url: url(${fe});\n  --map-tile-right-url: url(${ge});\n  --map-tile-center-url: url(${be});\n}\n\n.board.arctic {\n  --map-tile-top-left-url: url(${ve});\n  --map-tile-top-url: url(${ye});\n  --map-tile-top-right-url: url(${Ce});\n  --map-tile-bottom-left-url: url(${we});\n  --map-tile-bottom-url: url(${Pe});\n  --map-tile-bottom-right-url: url(${xe});\n  --map-tile-left-url: url(${Le});\n  --map-tile-right-url: url(${ke});\n  --map-tile-center-url: url(${Re});\n}\n\n.board.mountain {\n  --map-tile-top-left-url: url(${Me});\n  --map-tile-top-url: url(${Se});\n  --map-tile-top-right-url: url(${Ue});\n  --map-tile-bottom-left-url: url(${Ee});\n  --map-tile-bottom-url: url(${Te});\n  --map-tile-bottom-right-url: url(${$e});\n  --map-tile-left-url: url(${ze});\n  --map-tile-right-url: url(${Ge});\n  --map-tile-center-url: url(${Be});\n}\n\n.map-tile {\n  width: var(--cell-size);\n  height: var(--cell-size);\n}\n\n.map-tile-top-left {\n  background: var(--map-tile-top-left-url);\n}\n\n.map-tile-top {\n  background: var(--map-tile-top-url);\n}\n\n.map-tile-top-right {\n  background: var(--map-tile-top-right-url);\n}\n\n.map-tile-bottom-left {\n  background: var(--map-tile-bottom-left-url);\n}\n\n.map-tile-bottom {\n  background: var(--map-tile-bottom-url);\n}\n\n.map-tile-bottom-right {\n  background: var(--map-tile-bottom-right-url);\n}\n\n.map-tile-left {\n  background: var(--map-tile-left-url);\n}\n\n.map-tile-right {\n  background: var(--map-tile-right-url);\n}\n\n.map-tile-center {\n  background: var(--map-tile-center-url);\n}\n\n.character {\n  width: var(--cell-size);\n  height: var(--cell-size);\n  position: absolute;\n  z-index: 99;\n}\n\n.player::before {\n  content: '';\n  position: absolute; \n  width: 10px; \n  height: 10px;\n  top: 50px;\n  left: 50px;\n  border: 2px solid #000000;\n  border-radius: 10px;\n  background-color: #0f0;\n}\n\n.opponent::before {\n  content: '';\n  position: absolute; \n  width: 10px; \n  height: 10px;\n  top: 50px;\n  left: 50px;\n  border: 2px solid #000000;\n  border-radius: 10px;\n  background-color: #f00;\n}\n\n.character.generic {\n  background: url(${Ae});\n}\n\n.character.bowman {\n  background: url(${Oe});\n}\n\n.character.daemon {\n  background: url(${Ie});\n}\n\n.character.magician {\n  background: url(${Ne});\n}\n\n.character.swordsman {\n  background: url(${De});\n}\n\n.character.undead {\n  background: url(${Fe});\n}\n\n.character.vampire {\n  background: url(${je});\n}\n\n.character.zombie {\n  background: url(${qe});\n}\n\n.health-level {\n  top: 2px;\n  left: 7px;\n  position: absolute;\n  width: 50px;\n  height: 4px;\n  background: #000;\n}\n\n.health-level-indicator {\n  height: 4px;\n}\n\n.health-level-indicator-high {\n  background: #0f0;\n}\n\n.health-level-indicator-normal {\n  background: #ff0;\n}\n\n.health-level-indicator-critical {\n  background: #f00;\n}\n\n.damage {\n  position: absolute;\n  width: var(--cell-size);\n  text-align: center;\n  z-index: 999;\n  color: #f00;\n  font-weight: bold;\n  animation: 500ms fade ease-out;\n}\n\n@keyframes fade {\n  from {\n    opacity: 0;\n    top: calc(var(--cell-size) * 0.5);\n    font-size: 1rem;\n  }\n  to {\n    opacity: 1;\n    top: -20px;\n    font-size: 1.5rem;\n  }\n}\n`,""]);const He=Z},1113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},1216:(e,t,a)=>{e.exports=a.p+"c75f062dddba6e98fdc6.png"},1265:(e,t,a)=>{e.exports=a.p+"26b5f224d8750119922d.png"},1409:(e,t,a)=>{e.exports=a.p+"946aeb948db6313f1d85.png"},1601:e=>{e.exports=function(e){return e[1]}},1605:(e,t,a)=>{e.exports=a.p+"246277b8ca590816b3e8.png"},1906:(e,t,a)=>{e.exports=a.p+"f462d2ed6eedca1e4fd9.png"},2076:(e,t,a)=>{e.exports=a.p+"cec542854b228e61547a.png"},2573:(e,t,a)=>{e.exports=a.p+"0089a610e6611f679b50.png"},3062:(e,t,a)=>{e.exports=a.p+"eb1f6e4f87b977012684.png"},3160:(e,t,a)=>{e.exports=a.p+"6f6f7c09bde970b2e41b.png"},3232:(e,t,a)=>{e.exports=a.p+"0ac7f8258ec7166dc957.png"},3860:(e,t,a)=>{e.exports=a.p+"cf170a9fea1051b7424a.png"},3933:(e,t,a)=>{e.exports=a.p+"8b928c3eb136543e573a.png"},4041:(e,t,a)=>{e.exports=a.p+"3d9503e0a850fda86f82.png"},4184:(e,t,a)=>{e.exports=a.p+"f1703771380a9959d979.png"},4347:(e,t,a)=>{e.exports=a.p+"6bacb8e25ed9ecf726bf.png"},4417:e=>{e.exports=function(e,t){return t||(t={}),e?(e=String(e.__esModule?e.default:e),/^['"].*['"]$/.test(e)&&(e=e.slice(1,-1)),t.hash&&(e+=t.hash),/["'() \t\n]|(%20)/.test(e)||t.needQuotes?'"'.concat(e.replace(/"/g,'\\"').replace(/\n/g,"\\n"),'"'):e):e}},4437:(e,t,a)=>{e.exports=a.p+"26fdc25019c24e87f11a.png"},4496:(e,t,a)=>{e.exports=a.p+"258d884122fabfc2f312.png"},4875:(e,t,a)=>{e.exports=a.p+"2c19971f327b288278bb.png"},5056:(e,t,a)=>{e.exports=function(e){var t=a.nc;t&&e.setAttribute("nonce",t)}},5072:e=>{var t=[];function a(e){for(var a=-1,r=0;r<t.length;r++)if(t[r].identifier===e){a=r;break}return a}function r(e,r){for(var i={},s=[],o=0;o<e.length;o++){var l=e[o],c=r.base?l[0]+r.base:l[0],h=i[c]||0,d="".concat(c," ").concat(h);i[c]=h+1;var p=a(d),u={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==p)t[p].references++,t[p].updater(u);else{var m=n(u,r);r.byIndex=o,t.splice(o,0,{identifier:d,updater:m,references:1})}s.push(d)}return s}function n(e,t){var a=t.domAPI(t);return a.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;a.update(e=t)}else a.remove()}}e.exports=function(e,n){var i=r(e=e||[],n=n||{});return function(e){e=e||[];for(var s=0;s<i.length;s++){var o=a(i[s]);t[o].references--}for(var l=r(e,n),c=0;c<i.length;c++){var h=a(i[c]);0===t[h].references&&(t[h].updater(),t.splice(h,1))}i=l}}},5134:(e,t,a)=>{e.exports=a.p+"51e2a5de56bd631452fe.png"},5513:(e,t,a)=>{e.exports=a.p+"5cf9c17d6a1ea7106a6c.png"},5523:(e,t,a)=>{e.exports=a.p+"63aae58e4690953a3857.png"},6092:(e,t,a)=>{e.exports=a.p+"13edb269e39172ddd74f.png"},6153:(e,t,a)=>{e.exports=a.p+"e0aa3daf6d08c62c96d9.png"},6168:(e,t,a)=>{e.exports=a.p+"2007ec00c1d9f997e704.png"},6267:(e,t,a)=>{e.exports=a.p+"07d5e8127645225478b6.png"},6291:(e,t,a)=>{e.exports=a.p+"a1d2321024649b9d8f5f.png"},6314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var a="",r=void 0!==t[5];return t[4]&&(a+="@supports (".concat(t[4],") {")),t[2]&&(a+="@media ".concat(t[2]," {")),r&&(a+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),a+=e(t),r&&(a+="}"),t[2]&&(a+="}"),t[4]&&(a+="}"),a})).join("")},t.i=function(e,a,r,n,i){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(r)for(var o=0;o<this.length;o++){var l=this[o][0];null!=l&&(s[l]=!0)}for(var c=0;c<e.length;c++){var h=[].concat(e[c]);r&&s[h[0]]||(void 0!==i&&(void 0===h[5]||(h[1]="@layer".concat(h[5].length>0?" ".concat(h[5]):""," {").concat(h[1],"}")),h[5]=i),a&&(h[2]?(h[1]="@media ".concat(h[2]," {").concat(h[1],"}"),h[2]=a):h[2]=a),n&&(h[4]?(h[1]="@supports (".concat(h[4],") {").concat(h[1],"}"),h[4]=n):h[4]="".concat(n)),t.push(h))}},t}},6318:(e,t,a)=>{e.exports=a.p+"ef1b0ea8c4e545d9aadc.png"},6943:(e,t,a)=>{e.exports=a.p+"c0fa2b75539f94144dc4.png"},7335:(e,t,a)=>{e.exports=a.p+"eab6a2cc5e89a4dd8e3f.png"},7538:(e,t,a)=>{e.exports=a.p+"22e7c5ede3f747cbe27a.png"},7659:e=>{var t={};e.exports=function(e,a){var r=function(e){if(void 0===t[e]){var a=document.querySelector(e);if(window.HTMLIFrameElement&&a instanceof window.HTMLIFrameElement)try{a=a.contentDocument.head}catch(e){a=null}t[e]=a}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(a)}},7825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(a){!function(e,t,a){var r="";a.supports&&(r+="@supports (".concat(a.supports,") {")),a.media&&(r+="@media ".concat(a.media," {"));var n=void 0!==a.layer;n&&(r+="@layer".concat(a.layer.length>0?" ".concat(a.layer):""," {")),r+=a.css,n&&(r+="}"),a.media&&(r+="}"),a.supports&&(r+="}");var i=a.sourceMap;i&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,a)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},7935:(e,t,a)=>{e.exports=a.p+"46d63299c3420c030b4e.png"},7986:(e,t,a)=>{e.exports=a.p+"ac9d74f57639792774bc.png"},8341:(e,t,a)=>{e.exports=a.p+"0a77fc47d727eab6fd39.png"},8490:(e,t,a)=>{e.exports=a.p+"6a84ae91f5d985ddc9ee.png"},8956:(e,t,a)=>{e.exports=a.p+"dc3f97e7bbcd5ea1ded9.png"},9e3:(e,t,a)=>{e.exports=a.p+"d31d84c693f649766aee.png"},9221:(e,t,a)=>{e.exports=a.p+"2f1e1970c2c20cf3a8d5.png"},9334:(e,t,a)=>{e.exports=a.p+"296dfeac15e2377fc1dc.png"},9593:(e,t,a)=>{e.exports=a.p+"b27323cf850ed820855c.png"},9702:(e,t,a)=>{e.exports=a.p+"1d70f1dab2dd418c3612.png"},9745:(e,t,a)=>{e.exports=a.p+"546abb060a0837550fd1.png"}},t={};function a(r){var n=t[r];if(void 0!==n)return n.exports;var i=t[r]={id:r,exports:{}};return e[r](i,i.exports,a),i.exports}a.m=e,a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e;a.g.importScripts&&(e=a.g.location+"");var t=a.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var n=r.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=r[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=e})(),a.b=document.baseURI||self.location.href,a.nc=void 0;var r=a(5072),n=a.n(r),i=a(7825),s=a.n(i),o=a(7659),l=a.n(o),c=a(5056),h=a.n(c),d=a(540),p=a.n(d),u=a(1113),m=a.n(u),f=a(1016),g={};function b(e,t){const a=t-1,r=t*a,n=t*t-1;return 0===e?"top-left":e===a?"top-right":e===r?"bottom-left":e===n?"bottom-right":e>=0&&e<=a?"top":e%t==0?"left":e%t===a?"right":e>=r&&e<=n?"bottom":"center"}g.styleTagTransform=m(),g.setAttributes=h(),g.insert=l().bind(null,"head"),g.domAPI=s(),g.insertStyleElement=p(),n()(f.A,g),f.A&&f.A.locals&&f.A.locals;class v{constructor(){this.boardSize=4,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">Новая игра</button>\n        <button data-id="action-save" class="btn">Сохранить игру</button>\n        <button data-id="action-load" class="btn">Загрузить игру</button>\n      </div>\n      <div class="display">\n        <div class="info-panel">\n          <div class="level">\n            <div class="level-title">Уровень:</div>\n            <div class="level-number">0</div>\n          </div>  \n          <div class="points">\n            <div class="points-title">Очки:</div>\n            <div class="points-count">0</div>\n          </div>            \n        </div>         \n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n      <div class="message-panel">        \n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.container.querySelector(".board").style=`grid-template-columns: repeat(${this.boardSize}, 1fr);`,this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const t=document.createElement("div");t.classList.add("cell","map-tile",`map-tile-${b(e,this.boardSize)}`),t.addEventListener("mouseenter",(e=>this.onCellEnter(e))),t.addEventListener("mouseleave",(e=>this.onCellLeave(e))),t.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(t)}this.cells=Array.from(this.boardEl.children)}drawPoints(e){this.container.querySelector(".points-count").innerText=e}drawLevel(e){this.container.querySelector(".level-number").innerText=e}drawMessage(e,t="message-error"){const a=this.container.querySelector(".message-panel");a.className=`message-panel ${t}`,a.innerText=e,setTimeout((()=>a.innerText=""),2e3)}static classTeam(e){return e?"player":"opponent"}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const{positionedCharacter:a,flagTeamPlayer:r}of e){const e=this.boardEl.children[a.position],n=document.createElement("div");n.classList.add("character",v.classTeam(r),a.character.type);const i=document.createElement("div");i.classList.add("health-level");const s=document.createElement("div");s.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),s.style.width=`${a.character.health}%`,i.appendChild(s),n.appendChild(i),e.appendChild(n)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}highlightCell(e,t="green"){this.cells[e].classList.add("highlight",`highlight-${t}`)}backlight(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("highlight"))))}showDamage(e,t){return new Promise((a=>{const r=this.cells[e],n=document.createElement("span");n.textContent=t,n.classList.add("damage"),r.appendChild(n),n.addEventListener("animationend",(()=>{r.removeChild(n),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}const y="prairie",C="desert",w="arctic",P="mountain";class x{constructor(e){this.characters=e}}function L(e,t,a){const r=function*(e,t){for(;;){const a=Math.floor(Math.random()*e.length),r=Math.floor(Math.random()*t)+1;yield new e[a](r)}}(e,t),n=[];for(let e=0;e<a;e++)n.push(r.next().value);return new x(n)}class k{constructor(e="generic"){if(this.level=1,this.attack=0,this.defence=0,this.health=50,this.type=e,this.numberSteps=1,this.attackRadius=1,new.target===k)throw new Error("You cannot create a Character object directly!")}levelUp(e=2){for(let t=1;t<e;t++)this.level+=1,this.attack=Math.max(this.attack,Math.round(this.attack*(80+this.health)/100)),this.defence=Math.max(this.defence,Math.round(this.defence*(80+this.health)/100)),this.health=Math.min(100,Math.round(this.health+80))}}class R{constructor(e,t){if(!(e instanceof k))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class M{static stateGame;static from(e){if("number"!=typeof e.currentLevel||"boolean"!=typeof e.playerTurn||"number"!=typeof e.points||"number"!=typeof e.boardSize||"number"!=typeof e.characterCount||!Array.isArray(e.dataCharacterByPosition))throw new Error("Invalid state");return M.stateGame={},M.stateGame.currentLevel=e.currentLevel,M.stateGame.dataCharacterByPosition=e.dataCharacterByPosition,M.stateGame.playerTurn=e.playerTurn,M.stateGame.points=e.points,M.stateGame.boardSize=e.boardSize,M.stateGame.characterCount=e.characterCount,null}}class S extends k{constructor(e){super("bowman"),this.attack=25,this.defence=25,this.numberSteps=2,this.attackRadius=2,super.levelUp(e)}}class U extends k{constructor(e){super("swordsman"),this.attack=40,this.defence=10,this.numberSteps=4,this.attackRadius=1,super.levelUp(e)}}class E extends k{constructor(e){super("magician"),this.attack=10,this.defence=40,this.numberSteps=1,this.attackRadius=4,super.levelUp(e)}}class T extends k{constructor(e){super("daemon"),this.attack=10,this.defence=10,this.numberSteps=1,this.attackRadius=4,super.levelUp(e)}}class $ extends k{constructor(e){super("undead"),this.attack=40,this.defence=10,this.numberSteps=4,this.attackRadius=1,super.levelUp(e)}}class z extends k{constructor(e){super("vampire"),this.attack=25,this.defence=25,this.numberSteps=2,this.attackRadius=2,super.levelUp(e)}}class G extends k{constructor(e){super("zombie"),this.attack=50,this.defence=10,this.numberSteps=2,this.attackRadius=1,super.levelUp(e)}}class B{static charactersPlayer=[S,U,E,T,$,z,G];static charactersOpponent=[S,U,E,T,$,z,G];static characterTypes={bowman:S,swordsman:U,magician:E,daemon:T,undead:$,vampire:z,zombie:G};constructor(e,t){this.gamePlay=e,this.stateService=t,this.characterCount=1,this.currentLevel,this.dataCharacterByPosition=new Map,this.selectedCharacter=void 0,this.highlightedCells=[],this.moveCursor=void 0,this.playerTurn,this.blocking,this.points=0}init(){this.gameOrder("start"),this.subscribeEvents()}subscribeEvents(){this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addNewGameListener(this.onNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGame.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGame.bind(this))}static choiceTheme(e){switch((e-1)%4+1){case 1:return y;case 2:return C;case 3:return w;case 4:return P}}positionFormation(e,t){e.characters.forEach((e=>{const a=Math.round(this.gamePlay.boardSize/4);let r=0;do{const e=B.getRandomInRage(0,this.gamePlay.boardSize-1),n=B.getRandomInRage(0,a-1);r=e*this.gamePlay.boardSize+n,t||(r+=this.gamePlay.boardSize-a)}while(this.dataCharacterByPosition.has(r));this.dataCharacterByPosition.set(r,{positionedCharacter:new R(e,r),flagTeamPlayer:t})}))}static displayCharacteristics(e){return`🎖${e.level} ⚔${e.attack} 🛡${e.defence} ❤${e.health}`}static getRandomInRage(e,t){return Math.floor(Math.random()*(t-e+1))+e}coordinatesPosition(e){return{row:Math.floor(e/this.gamePlay.boardSize),col:e%this.gamePlay.boardSize}}shiftDifference(e,t){const a=this.coordinatesPosition(e),r=this.coordinatesPosition(t),n=Math.abs(a.row-r.row),i=Math.abs(a.col-r.col);return{differenceRow:n,differenceCol:i,difference:Math.abs(n-i)}}permissibleAttack(e){const t=this.selectedCharacter.character.attackRadius,a=this.shiftDifference(this.selectedCharacter.position,e,this.gamePlay.boardSize);return!(!a.differenceRow&&!a.differenceCol)&&a.differenceCol<=t&&a.differenceRow<=t}permissibleMovement(e){const t=this.selectedCharacter.character.numberSteps,a=this.shiftDifference(this.selectedCharacter.position,e,this.gamePlay.boardSize);return!(!a.differenceRow&&!a.differenceCol)&&(!a.differenceRow&&a.differenceCol<=t||!a.differenceCol&&a.differenceRow<=t||!a.difference&&a.differenceRow<=t)}teamComposition(e){const t={characters:[]};for(const{positionedCharacter:a,flagTeamPlayer:r}of this.dataCharacterByPosition.values())r===e&&t.characters.push(a.character);return t}redrawingLevel(){this.gamePlay.drawUi(B.choiceTheme(this.currentLevel)),this.gamePlay.redrawPositions([...this.dataCharacterByPosition.values()]),this.gamePlay.drawLevel(this.currentLevel)}startGame(){this.playerTurn=!0,this.currentLevel=1,this.gamePlay.boardSize=4,this.characterCount=1,this.dataCharacterByPosition=new Map,this.selectedCharacter=void 0;const e=L(B.charactersPlayer,this.currentLevel,this.characterCount);this.positionFormation(e,!0);const t=L(B.charactersOpponent,this.currentLevel,this.characterCount);this.positionFormation(t,!1),this.redrawingLevel()}movingNextLevel(){this.gamePlay.boardSize+=1,this.characterCount+=1,this.currentLevel+=1;const e=this.teamComposition(!0);for(const t of e.characters)t.levelUp();const t=L(B.charactersPlayer,this.currentLevel-1,this.characterCount-e.characters.length);t.characters.push(...e.characters),this.playerTurn=!0,this.dataCharacterByPosition.clear(),this.selectedCharacter=void 0,this.positionFormation(t,!0);const a=L(B.charactersOpponent,this.currentLevel,this.characterCount);this.positionFormation(a,!1),this.redrawingLevel()}loadGame(){try{const e=this.stateService.load();M.from(e),this.currentLevel=M.stateGame.currentLevel,this.playerTurn=M.stateGame.playerTurn,this.points=M.stateGame.points,this.selectedCharacter=void 0,this.gamePlay.boardSize=M.stateGame.boardSize,this.characterCount=M.stateGame.characterCount,this.dataCharacterByPosition=new Map;const t=M.stateGame.dataCharacterByPosition;for(const[e,{flagTeamPlayer:a,positionedCharacter:r}]of t){const t=r.character,n=new B.characterTypes[t.type](1);n.level=t.level,n.attack=t.attack,n.defence=t.defence,n.health=t.health,this.dataCharacterByPosition.set(e,{positionedCharacter:new R(n,e),flagTeamPlayer:a})}this.redrawingLevel(),this.gamePlay.drawMessage("Игра загружена!","message-info")}catch(e){this.gamePlay.drawMessage("Ошибка при загрузке игры!")}}changeCursor(e=-1,t="",a=""){this.moveCursor>=0&&(this.selectedCharacter&&this.moveCursor==this.selectedCharacter.position||(this.gamePlay.deselectCell(this.moveCursor),this.gamePlay.setCursor("default"),this.moveCursor=void 0)),e>=0&&(""!=t&&this.gamePlay.selectCell(e,t),this.moveCursor=e),""!=a&&this.gamePlay.setCursor(a)}gameOrder(e="turn"){this.highlightOff(),this.changeCursor(),"start"===e&&(this.startGame(),this.gamePlay.drawMessage("Новая игра!","message-info")),"load"===e&&this.loadGame(),0===this.teamComposition(!0).characters.length&&(this.startGame(),this.gamePlay.drawMessage("Поражение!","message-bad"),e=""),0===this.teamComposition(!1).characters.length&&(this.movingNextLevel(),this.gamePlay.drawMessage("Победа!","message-good"),e=""),"turn"===e&&(this.playerTurn=!this.playerTurn),this.blocking=!this.playerTurn,this.playerTurn?(this.highlightMoves(),this.highlightAttack()):this.responseOpponent(),this.gamePlay.drawPoints(this.points),M.from({currentLevel:this.currentLevel,dataCharacterByPosition:[...this.dataCharacterByPosition.entries()],playerTurn:this.playerTurn,points:this.points,boardSize:this.gamePlay.boardSize,characterCount:this.characterCount})}static damageCalculation(e,t){return Math.max(e-t,Math.round(e)/10)}characterMove(e,t,a){const r=e.position;e.position=t,this.dataCharacterByPosition.delete(r),this.dataCharacterByPosition.set(t,{positionedCharacter:e,flagTeamPlayer:a}),this.gamePlay.redrawPositions([...this.dataCharacterByPosition.values()]),a&&(this.gamePlay.selectCell(t),this.gamePlay.deselectCell(r),this.gamePlay.setCursor("default"))}characterAttack(e,t,a){return new Promise((r=>{const n=this.dataCharacterByPosition.get(t),i=n.positionedCharacter,s=B.damageCalculation(e.character.attack,i.character.defence);this.gamePlay.showDamage(t,s).then((()=>{i.character.health-=s,i.character.health<=0?(this.dataCharacterByPosition.delete(t),a||this.selectedCharacter===i&&(this.gamePlay.deselectCell(t),this.selectedCharacter=void 0)):this.dataCharacterByPosition.set(t,n),this.gamePlay.redrawPositions([...this.dataCharacterByPosition.values()]),a&&(this.points+=10*s,this.gamePlay.deselectCell(t),this.gamePlay.setCursor("default")),r()}))}))}positionByCoordinates(e,t){return e*this.gamePlay.boardSize+t}positionBySteps(e,t,a,r){const n=e+a,i=t+r;return this.positionByCoordinates(n,i)}cellUnderAttackPlayer(e,t,a,r=0,n=0){const i=[0];for(const s of t)for(const t of e){const e=t.row-s.row,o=t.col-s.col;let l=Math.abs(e),c=Math.abs(o);a===s&&(l=Math.abs(e-r),c=Math.abs(o-n));const h=l>c?l:c,d=t.positionedCharacter.character,p=s.positionedCharacter.character;if(h<=d.attackRadius){const e=B.damageCalculation(d.attack,p.defence);i.push(e)}}return Math.max(...i)}cellUnderAttackOpponent(e,t,a,r=0,n=0){const i=[0];for(const s of t)for(const t of e){const e=t.row-s.row,o=t.col-s.col;let l=Math.abs(e),c=Math.abs(o);a===s&&(l=Math.abs(e-r),c=Math.abs(o-n));const h=l>c?l:c,d=s.positionedCharacter.character,p=t.positionedCharacter.character;if(h<=d.attackRadius){const e=B.damageCalculation(d.attack,p.defence);i.push(e)}}return Math.max(...i)}static listFiltering(e,t){let a=e;for(const e of t)if(null!=e){if("max"===e.type){const t=a.reduce(((t,a)=>Math.max(t,a[e.value])),-1/0);a=a.filter((a=>a[e.value]===t))}if("min"===e.type){const t=a.reduce(((t,a)=>Math.min(t,a[e.value])),1/0);a=a.filter((a=>a[e.value]===t))}}return a}possibleMoves(e,t,a,r){const n=e.positionedCharacter.character,i=t.positionedCharacter.character,s=n.numberSteps,o=t.row-e.row,l=t.col-e.col,c=[];for(let t=-s;t<=s;t++)if(!(e.row+t<0||e.row+t>this.gamePlay.boardSize-1))for(let n=-s;n<=s;n++)if(!(e.col+n<0||e.col+n>this.gamePlay.boardSize-1||this.dataCharacterByPosition.has(this.positionBySteps(e.row,e.col,t,n))||Math.abs(t)!==Math.abs(n)&&0!==t&&0!==n)){const s=Math.abs(o-t),h=Math.abs(l-n),d=s>h?s:h,p=this.cellUnderAttackOpponent(r,a,e,t,n)-this.cellUnderAttackPlayer(r,a,e,t,n),u=this.positionBySteps(e.row,e.col,t,n);c.push({opponent:e,typeAction:2,actionPosition:u,stepsRow:t,stepsCol:n,relevance:p,healthPlayer:i.health,radius:d})}return c}possibleAttack(e,t,a,r,n){const i=e.positionedCharacter.character,s=t.positionedCharacter.character,o=i.attackRadius,l=t.row-e.row,c=t.col-e.col,h=Math.abs(l),d=Math.abs(c),p=h>d?h:d,u=this.cellUnderAttackOpponent(r,a,e),m=this.cellUnderAttackPlayer(r,a,e),f=u+B.damageCalculation(i.attack,s.defence)-m,g={opponent:e,typeAction:1,actionPosition:t.positionedCharacter.position,stepsRow:0,stepsCol:0,relevance:f,healthPlayer:s.health,radius:0};p<=o&&n.push(g)}responseOpponent(){const e=[],t=[];for(const a of this.dataCharacterByPosition.values())a.flagTeamPlayer?e.push({...a,...this.coordinatesPosition(a.positionedCharacter.position)}):t.push({...a,...this.coordinatesPosition(a.positionedCharacter.position)});const a=[];for(const r of t)for(const n of e){const i=this.possibleMoves(r,n,t,e);this.possibleAttack(r,n,t,e,i);const s=B.listFiltering(i,[{type:"max",value:"relevance"},{type:"min",value:"radius"}]),o=s[B.getRandomInRage(0,s.length-1)];a.push(o)}const r=B.listFiltering(a,[{type:"max",value:"relevance"},{type:"min",value:"healthPlayer"}]),n=r[B.getRandomInRage(0,r.length-1)];1===n.typeAction?this.characterAttack(n.opponent.positionedCharacter,n.actionPosition,!1).then((()=>{this.gameOrder()})):2===n.typeAction&&(this.characterMove(n.opponent.positionedCharacter,n.actionPosition,!1),this.gameOrder())}highlightMoves(){if(this.selectedCharacter){const e=this.selectedCharacter.character,t=this.coordinatesPosition(this.selectedCharacter.position),a=e.numberSteps;for(let e=-a;e<=a;e++)if(!(t.row+e<0||t.row+e>this.gamePlay.boardSize-1))for(let r=-a;r<=a;r++)if(!(t.col+r<0||t.col+r>this.gamePlay.boardSize-1||this.dataCharacterByPosition.has(this.positionBySteps(t.row,t.col,e,r))||Math.abs(e)!==Math.abs(r)&&0!==e&&0!==r)){const a=this.positionBySteps(t.row,t.col,e,r);this.gamePlay.highlightCell(a),this.highlightedCells.push(a)}}}highlightAttack(){if(this.selectedCharacter){const e=this.selectedCharacter.character,t=this.coordinatesPosition(this.selectedCharacter.position),a=e.attackRadius;for(const e of this.dataCharacterByPosition.values())if(!e.flagTeamPlayer){const r=this.coordinatesPosition(e.positionedCharacter.position),n=r.row-t.row,i=r.col-t.col,s=Math.abs(n),o=Math.abs(i);if((s>o?s:o)<=a){const t=e.positionedCharacter.position;this.gamePlay.highlightCell(t,"red"),this.highlightedCells.push(t)}}}}highlightOff(){for(const e of this.highlightedCells)this.gamePlay.backlight(e);this.highlightedCells=[]}actionsPlayer(e,t,a,r,n,i,s){if(!this.blocking){if(this.dataCharacterByPosition.has(e)){t();const n=this.dataCharacterByPosition.get(e),i=n.positionedCharacter;if(n&&n.flagTeamPlayer)return i===this.selectedCharacter?void a():void r()}if(this.selectedCharacter){if(this.dataCharacterByPosition.has(e)){const t=this.dataCharacterByPosition.get(e);if(t&&!t.flagTeamPlayer&&this.permissibleAttack(e))return void n()}else if(this.permissibleMovement(e))return void i();s()}}}onCellClick(e){this.actionsPlayer(e,(()=>{}),(()=>{this.highlightOff(),this.gamePlay.deselectCell(this.selectedCharacter.position),this.selectedCharacter=void 0}),(()=>{this.highlightOff(),this.selectedCharacter&&this.gamePlay.deselectCell(this.selectedCharacter.position),this.selectedCharacter=this.dataCharacterByPosition.get(e).positionedCharacter,this.gamePlay.selectCell(e),this.highlightMoves(),this.highlightAttack()}),(()=>{this.characterAttack(this.selectedCharacter,e,!0).then((()=>{this.gameOrder()}))}),(()=>{this.characterMove(this.selectedCharacter,e,!0),this.gameOrder()}),(()=>{}))}onCellEnter(e){this.actionsPlayer(e,(()=>{const t=this.dataCharacterByPosition.get(e).positionedCharacter.character;this.gamePlay.showCellTooltip(B.displayCharacteristics(t),e)}),(()=>{this.gamePlay.setCursor("pointer")}),(()=>{this.gamePlay.setCursor("pointer")}),(()=>{this.changeCursor(e,"red","crosshair")}),(()=>{this.changeCursor(e,"green","pointer")}),(()=>{this.gamePlay.setCursor("not-allowed")}))}onCellLeave(e){this.actionsPlayer(e,(()=>{this.gamePlay.hideCellTooltip(e)}),(()=>{this.gamePlay.setCursor("default")}),(()=>{this.gamePlay.setCursor("default")}),(()=>{this.changeCursor()}),(()=>{this.changeCursor()}),(()=>{this.gamePlay.setCursor("default")}))}onNewGame(){this.gameOrder("start")}onSaveGame(){this.stateService.save(M.stateGame),this.gamePlay.drawMessage("Игра сохранена!","message-info")}onLoadGame(){this.gameOrder("load")}}const A=new v;A.bindToDOM(document.querySelector("#game-container"));const O=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new B(A,O).init()})();